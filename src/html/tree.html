<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>请选择</title>
  <meta name="keywords" content="离退休老同志服务管理平台">
  <meta name="description" content="离退休老同志服务管理平台">
  <link rel="Shortcut Icon" href="../images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="../js/plugins/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="../js/plugins/bootstrap-table/bootstrap-table.min.css">
  <link rel="stylesheet" href="../js/plugins/zTree_v3/css/zTreeStyle/zTreeStyle.css">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .tree_btn {
      display: inline-block;
    }
  </style>
</head>

<body class="bg-white">
  <div class="tree-content" style="width: 800px;">
    <div class="clearfix">
      <div class="l pct50">
        <ul class="my-tab tab-active"></ul>
        <div class="tab-ct">
          <!-- 人员 -->
          <div class="item-ct" id="kj_tree">
            <ul id="userZTree" class="ztree"></ul>
          </div>
          <!-- 查询 -->
          <div class="item-ct dn" id="kj_search">
            <div class="">
              <input type="textbox" id="txtSearchKey" name="key" class="c_search_inputbox vm" placeholder="请输入名称或拼音"
                style="width:150px">
              <div id="seachBtn" class="c_search_btn vm"></div>
            </div>
            <table id="table" class="table-list table-hover table-striped table-bordered">
              <thead>
                <tr>
                  <td width="28%">姓名</td>
                  <td width="68%">性别</td>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
        <div id="kj_quanxuan" class="tree_btn">
          <a href="javascript:;" id="kj_all">
            <input type="checkbox" />
            <font color=black>全选</font>
          </a>
        </div>
        <div class="tree_btn" id="kj_diy">
          |&nbsp;<a href="javascript:;">
            <font color=black>维护自定义组</font>
          </a> |
          <a href="javascript:;">
            <font color=black>刷新自定义组</font>
          </a></div>
      </div>
      <div class="l pct50">
        <ul class="my-tab">
          <li>已选择用户</li>
        </ul>
        <div class="item-ct bd-lf">
          <ul id="userCheckList" class="checklist">
          </ul>
        </div>
        <div class="tips-ct">
          <span class="poi" id="clearAll">清空选择人员 </span>
          <span class="total">已选择个数:</span>
        </div>
      </div>
    </div>
    <div class="tc mt5">
      <button type="button" id="comfimSelect" class="btn btn-danger btn-sm">
        确认选择
      </button>
    </div>
  </div>
  <!-- 公共js start -->
  <script src="../js/plugins/jquery-3.3.1.min.js"></script>
  <script src="../js/libs.min.js"></script>
  <script src="../js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
  <script src="../js/plugins/echarts.min.js"></script>
  <script src="../js/plugins/My97DatePicker/WdatePicker.js"></script>
  <script src="../js/plugins/layer/layer.js"></script>
  <script src="../js/plugins/zTree_v3/js/jquery.ztree.all.min.js"></script>
  <script src="../js/common.js"></script>
  <!-- 公共js end -->
  <script>
    $(function () {
      //data  测试完注释掉
      var treedata = [
        {
          "iconSkin": "bm",
          "id": "70680",
          "isParent": true,
          "mc": "老同志",
          "sjid": "70670"
        },
        {
          "bmmc": "一支部",
          "childcount": 1,
          "iconSkin": "bm",
          "id": "70710",
          "isParent": true,
          "lx_dm": 201,
          "mc": "一支部",
          "sjid": "70680",
          "xh": 10001,
          "yhid": "70670_70680_70710"
        }, {
          "bmmc": "一支部",
          "childcount": 28,
          "iconSkin": "gw",
          "id": "71134",
          "isParent": true,
          "lx_dm": 202,
          "mc": "人员",
          "sjid": "70710",
          "xh": 10000,
          "yhid": "71134"
        }, {
          "bmmc": "一支部",
          "childcount": 0,
          "iconSkin": "yh",
          "id": "73791",
          "isParent": false,
          "lx_dm": 204,
          "mc": "ltz13",
          "sjid": "71134",
          "xh": 1010000,
          "yhid": "73791"
        }, {
          "bmmc": "一支部",
          "childcount": 0,
          "iconSkin": "yh",
          "id": "73841",
          "isParent": false,
          "lx_dm": 204,
          "mc": "cdc",
          "sjid": "71134",
          "xh": 1010000,
          "yhid": "73841"
        }, {
          "bmmc": "一支部",
          "childcount": 0,
          "iconSkin": "yh",
          "id": "73850",
          "isParent": false,
          "lx_dm": 204,
          "mc": "ltz12",
          "sjid": "71134",
          "xh": 1010000,
          "yhid": "73850"
        }];
      //////////////接受入参
      //控件input hidden值
      var sys_fsfw = getURLString('fbfw_value');
      //控件select id
      var sys_fsfw_lb = getURLString('sys_fsfw_lb');
      //默认显示
      var defaultTab = getURLString('defaultTab');
      //启用类型(0：部门人员 1：部门 2：岗位 3：人员 4：角色 5：自定义组 6：查询)
      var tab = getURLString('tab');
      ////////////////////////
      //全局树形对象
      var userZTree = null;
      //选中类型ID
      var check_id = -1;
      //选中集合
      var check_list = [];
      //选中方法
      var click_tree = null;
      //控件
      var kj_search = $("#kj_search"), kj_tree = $("#kj_tree"), kj_diy = $("#kj_diy"), kj_all = $("#kj_all"), kj_quanxuan = $("#kj_quanxuan");
      //是否全选
      var isAll = false;
      //缓存集合
      var cache_tree = [
        {
          id: 0,
          name: '部门人员',
          //组名称,项名称
          text: {
            group: "(部门)",
            item: "(用户)"
          },
          //是否启用
          show: false,
          //树形配置
          config_tree: {
            check: {
              enable: true,
              autoCheckTrigger: true,
              nocheckInherit: false,
              chkboxType: {
                "Y": "s",
                "N": "s"
              }
            },
            data: {
              key: {
                name: "mc",
                title: "mc",
                children: "nodes"
              },
              simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "sjid",
                rootPId: 0
              }
            },
            async: {
              enable: true,
              url: "http://119.188.117.54:8081/ryxz/default.do?method=getYhList&bmidvalue=70670_70680&fwbz=&mk_dm=15203",
              autoParam: ["id"],
              dataType: "text"
            },
            callback: {
              onAsyncSuccess: function (event, treeId, treeNode, msg) { },
              onAsyncError: function (event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) { },
              onClick: function (event, treeId, treeNode) { },
              onCheck: function (event, treeId, treeNode) {
                click_tree(event, treeId, treeNode)
              },
            },
            view: {
              dblClickExpand: false,
              autoCancelSelected: false
            }
          },
          //当前选中项
          ck: []
        }, {
          id: 1,
          name: '部门',
          //组名称,项名称
          text: {
            group: "(部门)",
            item: "(部门)"
          },
          //是否启用
          show: false,
          //树形配置
          config_tree: {
            check: {
              enable: true,
              autoCheckTrigger: true,
              nocheckInherit: false,
              chkboxType: {
                "Y": "s",
                "N": "s"
              }
            },
            data: {
              key: {
                name: "mc",
                title: "mc",
                children: "nodes"
              },
              simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "sjid",
                rootPId: 0
              }
            },
            async: {
              enable: true,
              url: "http://119.188.117.54:8081/ryxz/default.do?method=getYhList&bmidvalue=70670_70680&fwbz=&mk_dm=15203",
              autoParam: ["id"],
              dataType: "text"
            },
            callback: {
              onAsyncSuccess: function (event, treeId, treeNode, msg) { },
              onAsyncError: function (event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) { },
              onClick: function (event, treeId, treeNode) { },
              onCheck: function (event, treeId, treeNode) {
                click_tree(event, treeId, treeNode)
              },
            },
            view: {
              dblClickExpand: false,
              autoCancelSelected: false
            }
          },
          //当前选中项
          ck: []
        }, {
          id: 2,
          name: '岗位',
          //组名称,项名称
          text: {
            group: "(岗位)",
            item: "(用户)"
          },
          //是否启用
          show: false,
          //树形配置
          config_tree: {
            check: {
              enable: true,
              autoCheckTrigger: true,
              nocheckInherit: false,
              chkboxType: {
                "Y": "s",
                "N": "s"
              }
            },
            data: {
              key: {
                name: "mc",
                title: "mc",
                children: "nodes"
              },
              simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "sjid",
                rootPId: 0
              }
            },
            async: {
              enable: true,
              url: "http://119.188.117.54:8081/ryxz/default.do?method=getYhList&bmidvalue=70670_70680&fwbz=&mk_dm=15203",
              autoParam: ["id"],
              dataType: "text"
            },
            callback: {
              onAsyncSuccess: function (event, treeId, treeNode, msg) { },
              onAsyncError: function (event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) { },
              onClick: function (event, treeId, treeNode) { },
              onCheck: function (event, treeId, treeNode) {
                click_tree(event, treeId, treeNode)
              },
            },
            view: {
              dblClickExpand: false,
              autoCancelSelected: false
            }
          },
          //当前选中项
          ck: []
        }, {
          id: 3,
          name: '人员',
          //组名称,项名称
          text: {
            group: "",
            item: ""
          },
          //是否启用
          show: false,
          //树形配置
          config_tree: {
            check: {
              enable: true,
              autoCheckTrigger: true,
              nocheckInherit: false,
              chkboxType: {
                "Y": "s",
                "N": "s"
              }
            },
            data: {
              key: {
                name: "mc",
                title: "mc",
                children: "nodes"
              },
              simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "sjid",
                rootPId: 0
              }
            },
            async: {
              enable: true,
              url: "http://119.188.117.54:8081/ryxz/default.do?method=getYhList&bmidvalue=70670_70680&fwbz=&mk_dm=15203",
              autoParam: ["id"],
              dataType: "text"
            },
            callback: {
              onAsyncSuccess: function (event, treeId, treeNode, msg) { },
              onAsyncError: function (event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) { },
              onClick: function (event, treeId, treeNode) { },
              onCheck: function (event, treeId, treeNode) {
                click_tree(event, treeId, treeNode)
              },
            },
            view: {
              dblClickExpand: false,
              autoCancelSelected: false
            }
          },
          //当前选中项
          ck: []
        },
        {
          id: 4,
          name: '角色',
          //组名称,项名称
          text: {
            group: "",
            item: ""
          },
          //是否启用
          show: false,
          //树形配置
          config_tree: {
            check: {
              enable: true,
              autoCheckTrigger: true,
              nocheckInherit: false,
              chkboxType: {
                "Y": "s",
                "N": "s"
              }
            },
            data: {
              key: {
                name: "mc",
                title: "mc",
                children: "nodes"
              },
              simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "sjid",
                rootPId: 0
              }
            },
            async: {
              enable: true,
              url: "http://119.188.117.54:8081/ryxz/default.do?method=getYhList&bmidvalue=70670_70680&fwbz=&mk_dm=15203",
              autoParam: ["id"],
              dataType: "text"
            },
            callback: {
              onAsyncSuccess: function (event, treeId, treeNode, msg) { },
              onAsyncError: function (event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) { },
              onClick: function (event, treeId, treeNode) { },
              onCheck: function (event, treeId, treeNode) {
                click_tree(event, treeId, treeNode)
              },
            },
            view: {
              dblClickExpand: false,
              autoCancelSelected: false
            }
          },
          //当前选中项
          ck: []
        },
        {
          id: 5,
          name: '自定义组',
          //组名称,项名称
          text: {
            group: "",
            item: ""
          },
          //是否启用
          show: false,
          //树形配置
          config_tree: {
            check: {
              enable: true,
              autoCheckTrigger: true,
              nocheckInherit: false,
              chkboxType: {
                "Y": "s",
                "N": "s"
              }
            },
            data: {
              key: {
                name: "mc",
                title: "mc",
                children: "nodes"
              },
              simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "sjid",
                rootPId: 0
              }
            },
            async: {
              enable: true,
              url: "http://119.188.117.54:8081/ryxz/default.do?method=getYhList&bmidvalue=70670_70680&fwbz=&mk_dm=15203",
              autoParam: ["id"],
              dataType: "text"
            },
            callback: {
              onAsyncSuccess: function (event, treeId, treeNode, msg) { },
              onAsyncError: function (event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) { },
              onClick: function (event, treeId, treeNode) { },
              onCheck: function (event, treeId, treeNode) {
                click_tree(event, treeId, treeNode)
              },
            },
            view: {
              dblClickExpand: false,
              autoCancelSelected: false
            }
          },
          //当前选中项
          ck: []
        },
        {
          id: 6,
          name: '查询',
          //是否启用
          show: false
        }
      ]
      //验证数据是否存在
      var IsCheck = function (text) {
        var bl = -1;
        check_list.forEach((item, index) => {
          if (item.text == text) {
            bl = index;
            return false;
          }
        });
        return bl;
      }
      //获取显示文本
      var getText = function (node) {
        var option = cache_tree[check_id];
        var type_name = option.text.item;
        var IsItem = true;
        if (node.nodes && node.nodes.length) {
          IsItem = false;
          type_name = option.text.group;
        }
        var text = type_name + node.mc;
        //IsItem:true 没有下级，表示节点最后一级  判断它的bmmc 是否存在 则追加 ； 如：用户
        if (IsItem && node.bmmc) {
          text += '(' + node.bmmc + ')';
        }
        //如果是部门
        if (option.id == 1 && node.sjbmmc) {
          text += '(' + node.sjbmmc + ')';
        }
        //如果是自定义组
        if (option.id == 5 && node.sjbmmc && node.sjbmmc != 'null') {
          text += '(' + node.sjbmmc + ')';
        }
        return text;
      }
      //树形点击事件
      click_tree = function (event, treeId, treeNode) {
        //获取配置
        var option = cache_tree[check_id];
        var _text = getText(treeNode);
        if (treeNode.checked) {
          if (IsCheck(_text) == -1) {
            //如果不同类型 显示不同文本 请根据 option.id 区分 如 if(option.id==1){部门该怎么显示数据}
            check_list.push({
              id: treeNode.id,//对应类型的数据ID
              cid: check_id,//记录对应类型ID
              text: _text, //需要在右侧显示的文本
              tId: treeNode.tId //节点ID
            })
          }
        } else {
          if (IsCheck(_text) > -1) {
            check_list.splice(IsCheck(_text), 1);
          }
        }
        //更新界面
        changeView();
      }
      //根据类型绑定树形 ck_id：即将选中的ID
      var bindTree = function (ck_id) {
        var option = cache_tree[ck_id];
        //重新初始化前 缓存当前树形数据 销毁当前树
        if (userZTree) {
          //缓存选中
          cache_tree[check_id].ck = userZTree.getCheckedNodes(true);
          //销毁
          $.fn.zTree.destroy("userZTree");
        } else {
          kj_tree.show();
          kj_search.hide();
        }
        //自定义
        if (ck_id == 5) {
          kj_diy.show();
        } else {
          kj_diy.hide();
        }
        //查询
        if (ck_id == 6) {
          userZTree = null;
          kj_tree.hide();
          kj_search.show();
          kj_quanxuan.hide();
          return;
        }
        //全选初始化
        kj_quanxuan.show();
        isAll = false;
        kj_all.find("input:checkbox").prop("checked", false);
        //初始化
        userZTree = $.fn.zTree.init($("#userZTree"), option.config_tree, treedata); //测试完注释 treedata 也注释
        //userZTree = $.fn.zTree.init($("#userZTree"), option.config_tree); // 正式
        //标记当前类型
        check_id = ck_id;
        //恢复之前数据选中
        if (option.ck.length) {
          option.ck.forEach(item => {
            var node = userZTree.getNodeByTId(item.tId);
            //checkNode 第一个true表示选择 第二个表示下级是否选中
            userZTree.checkNode(node, true, true);
          })
        }
        userZTree.expandAll(true);
      }
      //删除临时缓存ck里的值
      var DeleteCk = function (ck_id, tId) {
        var option = cache_tree[ck_id];
        var _ck = option.ck;
        if (_ck.length) {
          _ck.forEach((item, index) => {
            if (item.tId == tId) {
              _ck.splice(index, 1);
              return false;
            }
          })
        }
        cache_tree[ck_id].ck = _ck;
      }
      //更新选中视图
      var changeView = function () {
        $('#userCheckList').empty()
        check_list.forEach((item, index) => {
          $('#userCheckList').append('<li class="poi" index="' + index + '" id="check_li_' + item.id + '" >' + item.text + '</li>');
        });
        $('#userCheckList li').click(function () {
          var i = parseInt($(this).attr("index"));
          //取消树形选中 
          if (check_list[i].tId != "search") {
            var node = userZTree.getNodeByTId(check_list[i].tId);
            userZTree.checkNode(node, false, false);
          }
          //删除数组
          check_list.splice(i, 1);
          //删除缓存
          DeleteCk(check_list[i].cid, check_list[i].tId);
          //删除界面
          $(this).remove();
        });
      }
      //加载tab及点击事件
      var loadtab = function () {
        $('.tab-active').empty();
        cache_tree.forEach((item, index) => {
          if (item.show) {
            $('.tab-active').append('<li ck_id="' + item.id + '" class="' + (index == check_id ? "active" : "") + '">' + item.name + '</li>');
          }
        });
        $('.tab-active li').click(function () {
          $('.tab-active li').removeAttr("class");
          $(this).addClass("active");
          bindTree(parseInt($(this).attr("ck_id")));
        })
      }
      //确定事件
      $("#comfimSelect").click(function () {
        window.opener.$("#" + sys_fsfw_lb).empty();
        var ids = "";
        if (check_list.length > 1) {
          window.opener.$("#" + sys_fsfw_lb).append("<option value=''>已选择" + (check_list.length) + "个</option>");
        }
        for (i = 0; i < check_list.length; i++) {
          ids += "," + check_list[i].id;
          window.opener.$("#" + sys_fsfw_lb).append("<option value='" + check_list[i].id + "'>" + check_list[i].text + "</option>");
        }
        if (ids) {
          ids = ids.substr(1);
        }
        window.opener.$("#" + sys_fsfw).attr("value", ids);
        window.opener.$("#" + sys_fsfw).trigger("input");
        window.close();
      });
      //清空选择
      $('#clearAll').on('click', function () {
        check_list.forEach(item => {
          if (item.tId == "search") {
            return;
          }
          var node = userZTree.getNodeByTId(item.tId);
          userZTree.checkNode(node, false, false);
        })
        //删除所有临时缓存
        cache_tree.forEach(item => {
          item.ck = [];
        });
        //清空选中
        check_list = [];
        changeView();
      });
      ///自定义组
      //维护
      kj_diy.find("a").eq(0).click(function () {
        PageAlert({
          title: '维护自定义组',
          width: '700px',
          height: '700px',
          url: './维护自定义组.html'
        }, 1);
      });
      //刷新
      kj_diy.find("a").eq(1).click(function () {
        bindTree(check_id);
      });
      ///全选
      kj_all.click(function () {
        isAll ? userZTree.checkAllNodes(false) : userZTree.checkAllNodes(true);
        kj_all.find("input:checkbox").prop("checked", !isAll);
        isAll = !isAll;
      });
      // 查询处理
      $('#seachBtn').on('click', function () {
        var seachtxt = $('#txtSearchKey').val();
        //用ajax获取数据成功后处理
        var obj = {
          "bmmc": "一支部",
          "childcount": 0,
          "iconSkin": "yh",
          "id": "73841",
          "isParent": false,
          "lx_dm": 204,
          "mc": "cdc",
          "sjid": "71134",
          "xh": 1010000,
          "yhid": "73841"
        }
        $('#table tbody').empty()
        $('#table tbody').append('<tr class="poi" data-id="' + obj.id + '" data-mc="' + obj.mc + '" data-bmmc="' + obj.bmmc + '" ><td width="28%" >' + obj.bmmc + '</td><td width="68%">' + obj.mc + '</td></tr>')
        $('#table tbody tr').on('click', function () {
          var _text = getText({
            nodes: [],
            mc: $(this).data('mc'),
            bmmc: $(this).data('bmmc'),
          });
          if (IsCheck(_text) == -1) {
            //如果不同类型 显示不同文本 请根据 option.id 区分 如 if(option.id==1){部门该怎么显示数据}
            check_list.push({
              id: $(this).data('id'),//对应类型的数据ID
              cid: check_id,//记录对应类型ID 这里不用更改
              text: _text, //需要在右侧显示的文本
              tId: "search" //节点ID 查询固定 在删除时判定一下
            });
          }
          changeView();
        });
      });
      //加载数据
      var loadData = function () {
        if (defaultTab) {
          check_id = parseInt(defaultTab);
        }
        if (tab) {
          var tabArr = tab.split(',');
          tabArr.forEach(item => {
            cache_tree.forEach(tree => {
              if (tree.id == parseInt(item)) {
                tree.show = true;
              }
            });
          });
        }
        //加载
        if (check_id > -1) {
          bindTree(check_id);
          //初始化显示
          loadtab();
        }
      }
      loadData();
    });
  </script>

</body>

</html>